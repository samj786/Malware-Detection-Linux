#include "processes.h"
#include <ctype.h>

#define MAX_LINE_LENGTH 4096

// Function to clean string (remove quotes and spaces)
void clean_string(char *str) {
    char *src = str, *dst = str;
    while (*src) {
        if (*src != '"' && (*src != ' ' || dst > str)) {
            *dst++ = *src;
        }
        src++;
    }
    *dst = '\0';
    // Remove trailing spaces
    while (dst > str && isspace(*(dst-1))) {
        *--dst = '\0';
    }
}

// Binary search implementation for large files
int binary_search_hash(const char *target_hash, const char *filename, MalwareInfo *info) {
    FILE *file = fopen(filename, "r");
    if (!file) {
        perror("Error opening malware database");
        return -1;
    }

    // Get file size
    fseek(file, 0, SEEK_END);
    long file_size = ftell(file);
    rewind(file);

    // Skip header
    char buffer[MAX_LINE_LENGTH];
    if (!fgets(buffer, sizeof(buffer), file)) {
        fclose(file);
        return -1;
    }

    long left = ftell(file);
    long right = file_size;
    
    while (left < right) {
        long mid = left + (right - left) / 2;
        fseek(file, mid, SEEK_SET);
        
        // Read rest of the current line if we're in the middle
        if (mid > 0) {
            if (!fgets(buffer, sizeof(buffer), file)) {
                break;
            }
        }

        // Read the actual line we want to compare
        if (!fgets(buffer, sizeof(buffer), file)) {
            break;
        }

        // Parse the line
        char *hash = strtok(buffer, ",");
        if (!hash) continue;

        clean_string(hash);
        
        int cmp = strcasecmp(hash, target_hash);
        
        if (cmp == 0) {
            // Match found, populate MalwareInfo structure
            strncpy(info->hash, hash, sizeof(info->hash) - 1);
            info->hash[sizeof(info->hash) - 1] = '\0';
            
            char *token = strtok(NULL, ",");
            if (token) {
                clean_string(token);
                strncpy(info->file_name, token, sizeof(info->file_name) - 1);
                info->file_name[sizeof(info->file_name) - 1] = '\0';
            }
            
            token = strtok(NULL, ",");
            if (token) {
                clean_string(token);
                strncpy(info->file_type_guess, token, sizeof(info->file_type_guess) - 1);
                info->file_type_guess[sizeof(info->file_type_guess) - 1] = '\0';
            }
            
            token = strtok(NULL, ",");
            if (token) {
                clean_string(token);
                strncpy(info->mime_type, token, sizeof(info->mime_type) - 1);
                info->mime_type[sizeof(info->mime_type) - 1] = '\0';
            }
            
            token = strtok(NULL, ",");
            if (token) {
                clean_string(token);
                strncpy(info->signature, token, sizeof(info->signature) - 1);
                info->signature[sizeof(info->signature) - 1] = '\0';
            }
            
            fclose(file);
            return 1;
        }
        
        if (cmp < 0) {
            left = ftell(file);
        } else {
            right = mid;
        }
    }

    fclose(file);
    return 0;
}

void* check_process_hashes(void *arg) {
    ThreadData *data = (ThreadData *)arg;
    const char *db_file = "full_sorted_file.csv";  // Updated filename
    MalwareInfo mal_info;
    int suspicious_count = 0;

    printf("Thread %d: Checking processes %d to %d\n", 
           data->thread_id, data->start_index, data->end_index - 1);

    for (int i = data->start_index; i < data->end_index; i++) {
        ProcessInfo *proc = &process_info_array[i];
        
        if (strcmp(proc->sha256_hash, "N/A") != 0) {
            if (binary_search_hash(proc->sha256_hash, db_file, &mal_info) > 0) {
                suspicious_count++;
                printf("\n[!] SUSPICIOUS PROCESS DETECTED [!]\n");
                printf("Process ID: %d\n", proc->pid);
                printf("Process Name: %s\n", proc->name);
                printf("File Name in Database: %s\n", mal_info.file_name);
                printf("File Type: %s\n", mal_info.file_type_guess);
                printf("MIME Type: %s\n", mal_info.mime_type);
                printf("Signature: %s\n", mal_info.signature);
                printf("SHA256: %s\n", mal_info.hash);
                printf("----------------------------------------\n");
            }
        }
    }

    printf("Thread %d completed: Found %d suspicious processes\n", 
           data->thread_id, suspicious_count);
    
    return NULL;
}